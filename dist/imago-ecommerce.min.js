var FulfillmentsCenter,indexOf=[].indexOf||function(t){for(var e=0,i=this.length;i>e;e++)if(e in this&&this[e]===t)return e;return-1};FulfillmentsCenter=function(){function t(t,e,i,o,n){this.$http=t,this.$rootScope=e,this.geoIp=i,this.imagoSettings=o,this.imagoUtils=n,this.get()}return t.prototype.data=[],t.prototype.loaded=!1,t.prototype.selected={},t.prototype.get=function(){return this.$http.get(this.imagoSettings.host+"/api/fulfillmentcenters").then(function(t){return function(e){return t.data=e.data,t.getOptions()}}(this))},t.prototype.getOptions=function(){var t,e;return 1===this.data.length?(this.selected=this.data[0],this.loaded=!0,this.$rootScope.$emit("fulfillments:loaded",this.data)):(null!=(t=this.geoIp.data)?t.country:void 0)?this.geoValid():null===this.geoIp.data?this.getGeneric():this.geoIp.loaded?void 0:e=this.$rootScope.$on("geoip:loaded",function(t){return function(i,o){var n;return e(),(null!=(n=t.geoIp.data)?n.country:void 0)?t.geoValid():t.getGeneric()}}(this))},t.prototype.getGeneric=function(){return this.selected=_.find(this.data,function(t){return!t.countries.length}),this.$rootScope.$emit("fulfillments:loaded",this.data),this.loaded=!0},t.prototype.geoValid=function(){return this.selected=_.find(this.data,function(t){return function(e){var i;return i=t.geoIp.data.country,indexOf.call(e.countries,i)>=0}}(this)),this.selected?(this.$rootScope.$emit("fulfillments:loaded",this.data),void(this.loaded=!0)):this.getGeneric()},t}(),angular.module("imago").service("fulfillmentsCenter",["$http","$rootScope","geoIp","imagoSettings","imagoUtils",FulfillmentsCenter]);var GeoIp;GeoIp=function(){function t(t,e,i){this.$rootScope=t,this.$http=e,this.imagoUtils=i,this.get()}return t.prototype.data={},t.prototype.loaded=!1,t.prototype.get=function(){return this.$http.get("//api.imago.io/geoip").then(function(t){return function(e){var i;return _.isEmpty(e.data)?t.getCookie():(i=t.imagoUtils.getCountryByCode(e.data.country_code),t.imagoUtils.cookie("countryGeo",e.data.country_code),t.data.country=i,t.$rootScope.$emit("geoip:loaded",t.data),t.loaded=!0)}}(this),function(t){return function(e){return t.getCookie()}}(this))},t.prototype.getCookie=function(){return this.imagoUtils.cookie("countryGeo")?(this.data.country=this.imagoUtils.getCountryByCode(this.imagoUtils.cookie("countryGeo")),this.$rootScope.$emit("geoip:loaded",this.data),this.loaded=!0):(this.data=null,this.$rootScope.$emit("geoip:loaded",this.data),this.loaded=!0)},t}(),angular.module("imago").service("geoIp",["$rootScope","$http","imagoUtils",GeoIp]);var ImagoCartMessages;ImagoCartMessages=function(){function t(){return{scope:{item:"=imagoCartMessages"},templateUrl:"/imago/imago-cart-messages.html"}}return t}(),angular.module("imago").directive("imagoCartMessages",[ImagoCartMessages]);var ImagoCartUtils,indexOf=[].indexOf||function(t){for(var e=0,i=this.length;i>e;e++)if(e in this&&this[e]===t)return e;return-1};ImagoCartUtils=function(){function t(){return{updateChangedItem:function(t){var e,i,o,n,a,r,s,c,l,u,h;return t.updates=[],t.changed.length?(t.finalsale=null!=(e=t.fields)&&null!=(i=e.finalSale)?i.value:void 0,t.presale=null!=(n=t.fields)&&null!=(a=n.presale)?a.value:void 0,t.qty>t.stock&&(t.qty=t.stock,t.updates.push("quantity")),indexOf.call(t.changed,"price")>=0&&(t.price=null!=(r=t.fields)&&null!=(s=r.price)?s.value:void 0,t.updates.push("price")),indexOf.call(t.changed,"discountedPrice")>=0&&(null!=(c=t.fields)&&null!=(l=c.discountedPrice)&&null!=(u=l.value)?u[this.currency]:void 0)&&(t.price=null!=(h=t.fields)&&null!=(o=h.discountedPrice)?o.value:void 0,indexOf.call(t.updates,"price")<0&&t.updates.push("price")),t):t}}}return t}(),angular.module("imago").factory("imagoCartUtils",[ImagoCartUtils]);var imagoCart,imagoCartController;imagoCart=function(){function t(){return{replace:!0,scope:{min:"=",max:"=",ngModel:"="},transclude:!0,templateUrl:"/imago/imago-cart.html",controller:"imagoCartController as cart"}}return t}(),imagoCartController=function(){function t(t,e){this.imagoCart=t,this.$location=e,this.clickOut=function(t,e){return"BUTTON"!==t.target.tagName||-1===t.target.className.indexOf(e)?this.imagoCart.show=!1:void 0}}return t.prototype.goToProduct=function(t){return this.$location.url(t)},t}(),angular.module("imago").directive("imagoCart",[imagoCart]).controller("imagoCartController",["imagoCart","$location",imagoCartController]);var imagoCart,bind=function(t,e){return function(){return t.apply(e,arguments)}},indexOf=[].indexOf||function(t){for(var e=0,i=this.length;i>e;e++)if(e in this&&this[e]===t)return e;return-1};imagoCart=function(){function t(t,e,i,o,n,a,r,s,c,l,u,h){this.$q=t,this.$rootScope=e,this.$location=i,this.$window=o,this.$http=n,this.imagoUtils=a,this.imagoModel=r,this.fulfillmentsCenter=s,this.geoIp=c,this.imagoSettings=l,this.imagoCartUtils=h,this.remove=bind(this.remove,this),this.update=bind(this.update,this),this.create=bind(this.create,this),this.checkCart=bind(this.checkCart,this),this.checkStatus=bind(this.checkStatus,this),this.cart={items:[]},u.loaded?this.onSettings():this.$rootScope.$on("settings:loaded",function(t){return function(e,i){return t.onSettings()}}(this))}return t.prototype.show=!1,t.prototype.itemsLength=0,t.prototype.settings=[],t.prototype.onSettings=function(){var t;return this.currencies=this.$rootScope.tenantSettings.currencies,t=this.imagoUtils.cookie("imagoCart"),t?this.checkStatus(t):this.checkGeoIp()},t.prototype.checkGeoIp=function(){var t;return this.geoIp.loaded?this.checkCurrency():(this.checkCurrency(),t=this.$rootScope.$on("geoip:loaded",function(e){return function(i,o){return e.checkCurrency(),t()}}(this)))},t.prototype.checkCurrency=function(){var t,e;return _.isEmpty(this.geoIp.data)||(t=this.imagoUtils.CURRENCY_MAPPING[this.geoIp.data.country]),t&&this.currencies&&indexOf.call(this.currencies,t)>=0?this.currency=t:(null!=(e=this.currencies)?e.length:void 0)?this.currency=this.currencies[0]:console.log("you need to enable at least one currency in the settings"),this.$rootScope.$emit("imagocart:currencyloaded"),this.cart?(this.cart.currency!==this.currency&&(this.cart.currency=angular.copy(this.currency),this.update()),this.calculate()):void 0},t.prototype.checkStatus=function(t){return this.$http.get(this.imagoSettings.host+"/api/carts?cartid="+t).then(function(t){return function(e){var i;return console.log("check cart",e.data),_.assign(t.cart,e.data),t.fulfillmentsCenter.loaded?t.statusLoaded():i=t.$rootScope.$on("fulfillments:loaded",function(e,o){return t.statusLoaded(),i()})}}(this))},t.prototype.statusLoaded=function(){var t,e,i,o,n,a,r,s,c;for(c=!1,o=this.cart.items,t=0,i=o.length;i>t;t++)e=o[t],e.stock=Number(null!=(n=e.fields)&&null!=(a=n.stock)&&null!=(r=a.value)?r[this.fulfillmentsCenter.selected._id]:void 0),e=this.imagoCartUtils.updateChangedItem(e),(null!=(s=e.updates)?s.length:void 0)&&(this.newmessages=!0,c=!0);return this.currency||(this.currency=angular.copy(this.cart.currency)),c&&this.update(),this.calculate(),this.checkGeoIp()},t.prototype.checkCart=function(){var t;return t=this.$q.defer(),this.cart._id?t.resolve("update"):this.create(this.cart).then(function(e){return function(i){return _.assign(e.cart,i.data),e.imagoUtils.cookie("imagoCart",i.data._id),t.resolve("created")}}(this)),t.promise},t.prototype.create=function(t){return this.$http.post(this.imagoSettings.host+"/api/carts",t)},t.prototype.add=function(t,e,i){var o,n,a,r,s,c,l,u,h,d,g,p,m,f,v,y,C,$,S,k,w,I,b,U,q,O,G;if(!t)return console.log("item required");if(!t.qty)return console.log("quantity required");if(t.finalsale=null!=(d=t.fields)&&null!=(g=d.finalSale)?g.value:void 0,t.presale=null!=(k=t.fields)&&null!=(w=k.presale)?w.value:void 0,_.isArray(e)&&(null!=e?e.length:void 0))for(t.options={},r=0,c=e.length;c>r;r++)u=e[r],t.options[u]=t.fields[u];else _.isPlainObject(e)&&(t.options=e);if((null!=(I=t.options)?I.name:void 0)&&(t.name=t.options.name,delete t.options.name),h=this.imagoModel.find({_id:t.parent}))if(t.name||(t.name=null!=(b=h.fields)&&null!=(U=b.title)?U.value:void 0),t.serving_url||(t.serving_url=h.serving_url),null!=(q=t.fields)&&null!=(O=q.title)&&(O.value=null!=(G=h.fields)&&null!=(p=G.title)?p.value:void 0),null!=(m=t.fields)&&null!=(f=m.description)&&(f.value=null!=(v=h.fields)&&null!=(y=v.description)?y.value:void 0),_.isArray(i)&&i.length)for(s=0,l=i.length;l>s;s++)n=i[s],t.fields[n]=h.fields[n];else _.isPlainObject(i)&&_.assign(t.fields,h.fields);return o=angular.copy(t),a=_.find(this.cart.items,{_id:o._id}),(null!=(C=o.fields)&&null!=($=C.discountedPrice)&&null!=(S=$.value)?S[this.currency]:void 0)?o.price=o.fields.discountedPrice.value:o.price=o.fields.price.value,o.link=this.$location.url(),a?(a.name||(a.name=o.name),a.qty!==a.stock&&(a.qty+=o.qty),_.assign(a.options,o.options),_.assign(a.fields,o.fields)):this.cart.items.push(o),this.show=!0,this.calculate(),this.checkCart().then(function(t){return function(e){return"update"===e?t.update():void 0}}(this))},t.prototype.update=function(){return this.cart._id?this.$http.put(this.imagoSettings.host+"/api/carts/"+this.cart._id,this.cart):void 0},t.prototype.remove=function(t){return _.remove(this.cart.items,{_id:t._id}),this.calculate(),this.update()},t.prototype.calculate=function(){var t,e,i,o,n,a;if(this.itemsLength=0,this.subtotal=0,!this.cart.items.length)return this.subtotal=0,void(this.itemsLength=0);for(o=this.cart.items,a=[],t=0,i=o.length;i>t;t++)e=o[t],this.itemsLength+=e.qty,e.qty&&(null!=(n=e.price)?n[this.currency]:void 0)&&a.push(this.subtotal+=e.qty*e.price[this.currency]);return a},t.prototype.checkout=function(){var t,e;if(tenant)return e="https://"+tenant+".imago.io/account/checkout/"+this.cart._id,t="","function"==typeof ga&&ga(function(i){return function(o){var n;return n=new i.$window.gaplugins.Linker(o),t=n.decorate(e,!0)}}(this)),this.$window.location.href=t||e},t}(),angular.module("imago").service("imagoCart",["$q","$rootScope","$location","$window","$http","imagoUtils","imagoModel","fulfillmentsCenter","geoIp","imagoSettings","tenantSettings","imagoCartUtils",imagoCart]);var ShippingCountries;ShippingCountries=function(){function t(t,e){this.$http=t,this.imagoSettings=e,this.get()}return t.prototype.data=[],t.prototype.loaded=!1,t.prototype.get=function(){return this.$http.get(this.imagoSettings.host+"/api/shippingmethods").then(function(t){return function(e){var i,o,n,a,r,s,c,l;for(c=e.data,o=0,a=c.length;a>o;o++)for(s=c[o],l=s.countries,n=0,r=l.length;r>n;n++)i=l[n],t.data.push(i);return t.data=_.sortBy(_.compact(_.uniq(t.data))),t.loaded=!0}}(this))},t}(),angular.module("imago").service("shippingCountries",["$http","imagoSettings",ShippingCountries]);var VariantsStorage;VariantsStorage=function(){function t(t,e,i,o){this.$http=t,this.$q=e,this.imagoModel=i,this.imagoSettings=o}return t.prototype.data=[],t.prototype.search=function(t){return this.$http.get(this.imagoSettings.host+"/api/variants/"+t)},t.prototype.get=function(t){var e,i,o;return o=this.$q.defer(),e=this.imagoModel.find({_id:t}),i=_.filter(this.data,{parent:t}),(null!=e?e.variants.length:void 0)===i.length?o.resolve(i):this.search(t).then(function(t){return o.resolve(t.data)}),o.promise},t}(),angular.module("imago").service("variantsStorage",["$http","$q","imagoModel","imagoSettings",VariantsStorage]),angular.module("imago").run(["$templateCache",function(t){t.put("/imago/imago-cart-messages.html",'<div class="messages"><div ng-repeat="key in item.updates" ng-swich="key" class="message"><p ng-swich-wen="price">price has changed.</p><p ng-swich-wen="quantity">quantity has been updated.</p></div></div>'),t.put("/imago/imago-cart.html",'<div class="cart"><div ng-class="{\'message\': cart.imagoCart.newmessages}" ng-mouseenter="cart.imagoCart.show = true" ng-click="cart.imagoCart.show = !cart.imagoCart.show" analytics-on="click" analytics-event="Show Cart {{cart.imagoCart.show}}" class="icon"><div ng-bind="cart.imagoCart.itemsLength" class="counter"></div></div><div ng-show="cart.imagoCart.show" stop-scroll="stop-scroll" class="box"><div ng-transclude="ng-transclude"></div><div ng-show="cart.imagoCart.itemsLength" class="itemnumber">{{cart.imagoCart.itemsLength}}<span ng-show="cart.imagoCart.itemsLength === 1"> item</span><span ng-show="cart.imagoCart.itemsLength &gt; 1"> items</span></div><div ng-show="cart.imagoCart.itemsLength === 0" class="noitems">cart empty</div><div ng-show="cart.imagoCart.itemsLength" class="subtotal">subtotal:<span ng-bind-html="cart.imagoCart.currency | currencySymbol" class="currency"></span><span class="amount">{{cart.imagoCart.subtotal | price:0}}</span></div><button ng-show="cart.imagoCart.cart.items.length" type="submit" ng-click="cart.imagoCart.checkout()" analytics-on="click" analytics-event="Go to Checkout" class="checkout">checkout</button></div></div>')}]);