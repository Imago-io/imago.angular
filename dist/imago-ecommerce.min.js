!function(){var t,n=[].indexOf||function(t){for(var i=0,e=this.length;i<e;i++)if(i in this&&this[i]===t)return i;return-1};function i(t,i,e,n,s){this.$http=t,this.$rootScope=i,this.geoIp=e,this.imagoModel=n,this.imagoUtils=s,this.get()}i.prototype.data=[],i.prototype.loaded=!1,i.prototype.selected={},i.prototype.get=function(){return this.$http.get(this.imagoModel.host+"/api/fulfillmentcenters").then((i=this,function(t){return i.data=t.data,i.getOptions()}));var i},i.prototype.getOptions=function(){var t,n,s;return 1===this.data.length?(this.selected=this.data[0],this.loaded=!0,this.$rootScope.$emit("fulfillments:loaded",this.data)):null!=(t=this.geoIp.data)&&t.country?this.geoValid():null===this.geoIp.data?this.getGeneric():this.geoIp.loaded?void 0:n=this.$rootScope.$on("geoip:loaded",(s=this,function(t,i){var e;return n(),null!=(e=s.geoIp.data)&&e.country?s.geoValid():s.getGeneric()}))},i.prototype.getGeneric=function(){return this.selected=_.find(this.data,function(t){return!t.countries.length}),this.$rootScope.$emit("fulfillments:loaded",this.data),this.loaded=!0},i.prototype.geoValid=function(){var e;if(this.selected=_.find(this.data,(e=this,function(t){var i=e.geoIp.data.country;return 0<=n.call(t.countries,i)})),!this.selected)return this.getGeneric();this.$rootScope.$emit("fulfillments:loaded",this.data),this.loaded=!0},t=i,angular.module("imago").service("fulfillmentsCenter",["$http","$rootScope","geoIp","imagoModel","imagoUtils",t])}.call(this),function(){var t;function i(t,i,e,n){this.$rootScope=t,this.$http=i,this.imagoModel=e,this.imagoUtils=n,this.get()}i.prototype.data={},i.prototype.loaded=!1,i.prototype.get=function(){return this.$http.get("https://us-east4-imagoblobs.cloudfunctions.net/imago-geoip").then(function(t){return _.isEmpty(t.data)?e.getCookie():(e.imagoUtils.cookie("countryGeo",t.data.country),e.data=t.data,e.$rootScope.$emit("geoip:loaded",e.data),e.loaded=!0,t.data)},(i=e=this,function(t){return i.getCookie()}));var i,e},i.prototype.getCookie=function(){return this.imagoUtils.cookie("countryGeo")?this.data.country=this.imagoUtils.getCountryByCode(this.imagoUtils.cookie("countryGeo")):this.data=null,this.$rootScope.$emit("geoip:loaded",this.data),this.loaded=!0},t=i,angular.module("imago").service("geoIp",["$rootScope","$http","imagoModel","imagoUtils",t])}.call(this),function(){var t=function(){return{restrict:"E",scope:{item:"=imagoCartMessages"},templateUrl:"/imago/imago-cart-messages.html"}};angular.module("imago").directive("imagoCartMessages",[t])}.call(this),function(){var e=[].indexOf||function(t){for(var i=0,e=this.length;i<e;i++)if(i in this&&this[i]===t)return i;return-1},t=function(){return{updateChangedItem:function(t){var i;return t.updates=[],t.changed.length&&(t.finalsale=null!=(i=t.fields)&&null!=(i=i.finalSale)?i.value:void 0,t.presale=null!=(i=t.fields)&&null!=(i=i.presale)?i.value:void 0,t.stock<t.qty&&!t.presale&&(t.qty=t.stock,t.updates.push("quantity")),0<=e.call(t.changed,"price")&&(t.price=null!=(i=t.fields)&&null!=(i=i.price)?i.value:void 0,t.updates.push("price")),0<=e.call(t.changed,"discountedPrice"))&&null!=(i=t.fields)&&null!=(i=i.discountedPrice)&&null!=(i=i.value)&&i[this.currency]&&(t.price=null!=(i=t.fields)&&null!=(i=i.discountedPrice)?i.value:void 0,e.call(t.updates,"price")<0)&&t.updates.push("price"),t}}};angular.module("imago").factory("imagoCartUtils",[t])}.call(this),function(){var t,i;function e(t,i,e,n,s){var o,a,r,l,c,u;for(this.imagoCart=e,this.$location=n,this.opts={hideOnScroll:!0},o=0,r=(l=Object.keys(this.opts)).length;o<r;o++)!s[a=l[o]]||"true"!==(c=s[a])&&"false"!==c||(this.opts[a]=JSON.parse(s[a]));this.opts.hideOnScroll&&t.$on("scrollstart",(u=this,function(){return u.imagoCart.show=!1}))}t=function(){return{restrict:"E",transclude:!0,templateUrl:function(t,i){return i.templateUrl||"/imago/imago-cart.html"},controller:"imagoCartController as cart"}},e.prototype.maxQty=function(t){if(t)return t.presale?this.imagoCart.maxQtyPerItem||100:Math.min(this.imagoCart.maxQtyPerItem||100,t.stock)},e.prototype.goToProduct=function(t){return this.$location.url(t)},i=e,angular.module("imago").directive("imagoCart",[t]).controller("imagoCartController",["$rootScope","$scope","imagoCart","$location","$attrs",i])}.call(this),function(){function p(t,i){return function(){return t.apply(i,arguments)}}var t,i=[].indexOf||function(t){for(var i=0,e=this.length;i<e;i++)if(i in this&&this[i]===t)return i;return-1};function e(t,i,e,n,s,o,a,r,l,c,u,h){if(this.$q=t,this.$rootScope=i,this.$timeout=e,this.$location=n,this.$window=s,this.$http=o,this.imagoUtils=a,this.imagoModel=r,this.fulfillmentsCenter=l,this.geoIp=c,this.tenantSettings=u,this.imagoCartUtils=h,this.remove=p(this.remove,this),this.update=p(this.update,this),this.create=p(this.create,this),this.checkCart=p(this.checkCart,this),this.checkStatus=p(this.checkStatus,this),this.cart={items:[]},this.tenantSettings.loaded)return this.onSettings();var d;this.$rootScope.$on("settings:loaded",(d=this,function(t,i){return d.onSettings()}))}e.prototype.show=!1,e.prototype.itemsLength=0,e.prototype.settings=[],e.prototype.messages=[],e.prototype.onSettings=function(){var t;if(this.currencies=this.$rootScope.tenantSettings.currencies,null!=(t=this.$rootScope.tenantSettings.maxQtyPerItem)&&t.active&&(this.maxQtyPerItem=null!=(t=this.$rootScope.tenantSettings.maxQtyPerItem)?t.value:void 0),this.checkGeoIp(),t=this.imagoUtils.cookie("imagoCart"))return this.checkStatus(t)},e.prototype.checkGeoIp=function(){var e,n;return this.geoIp.loaded?this.checkCurrency():(this.checkCurrency(),e=this.$rootScope.$on("geoip:loaded",(n=this,function(t,i){return n.checkCurrency(),e()})))},e.prototype.checkCurrency=function(){var t;if((t=_.isEmpty(this.geoIp.data)?t:this.imagoUtils.CURRENCY_MAPPING[this.geoIp.data.country])&&this.currencies&&0<=i.call(this.currencies,t)?this.currency=t:null!=(t=this.currencies)&&t.length?this.currency=this.currencies[0]:console.log("you need to enable at least one currency in the settings"),this.$rootScope.$emit("imagocart:currencyloaded"),this.cart)return this.cart.currency!==this.currency&&(this.cart.currency=angular.copy(this.currency),this.update()),this.calculate()},e.prototype.checkStatus=function(t){return this.$http.get(this.imagoModel.host+"/api/carts?cartid="+t).then((n=this,function(t){var e;return _.assign(n.cart,t.data),n.fulfillmentsCenter.loaded?n.statusLoaded():e=n.$rootScope.$on("fulfillments:loaded",function(t,i){return n.statusLoaded(),e()})}));var n},e.prototype.statusLoaded=function(){for(var t,i,e=!1,n=this.cart.items,s=0,o=n.length;s<o;s++)(t=n[s]).stock=Number(null!=(i=t.fields)&&null!=(i=i.stock)&&null!=(i=i.value)?i[this.fulfillmentsCenter.selected._id]:void 0),(t=this.imagoCartUtils.updateChangedItem(t)).stock<=0&&!t.presale?(this.newmessages=!0,e=this.show=!0,this.messages.push({item:t,type:"nostock"}),_.remove(this.cart.items,{_id:t._id})):null!=(i=t.updates)&&i.length&&(this.newmessages=!0,e=this.show=!0);return this.currency||(this.currency=angular.copy(this.cart.currency)),e&&this.update(),this.calculate(),this.checkGeoIp()},e.prototype.checkCart=function(){return this.cart._id?this.$q.resolve("update"):this.create(this.cart).then((i=this,function(t){return _.assign(i.cart,t.data),i.imagoUtils.cookie("imagoCart",t.data._id),t.data}));var i},e.prototype.create=function(t){return this.$http.post(this.imagoModel.host+"/api/carts",t)},e.prototype.add=function(t,i,e,n){var s,o,a,r,l,c,u,h,d,p,g,m;if(!t)return console.log("item required");if((t.stock<=0||!t.stock)&&!t.presale)return console.log("no stock");if(t.qty||(t.qty=1),t.finalsale=null!=(p=t.fields)&&null!=(p=p.finalSale)?p.value:void 0,t.presale=null!=(p=t.fields)&&null!=(p=p.presale)?p.value:void 0,_.isArray(i)&&null!=i&&i.length)for(t.options={},a=0,l=i.length;a<l;a++)u=i[a],t.options[u]=t.fields[u];else _.isPlainObject(i)&&(t.options=i);if(null!=(p=t.options)&&p.name&&(t.name=t.options.name,delete t.options.name),h=this.imagoModel.find({_id:t.parent}))if(t.name||(t.name=null!=(p=h.fields)&&null!=(p=p.title)?p.value:void 0),t.serving_url||(t.serving_url=h.serving_url),null!=(p=t.fields)&&null!=(p=p.title)&&(p.value=null!=(p=h.fields)&&null!=(p=p.title)?p.value:void 0),null!=(p=t.fields)&&null!=(p=p.description)&&(p.value=null!=(p=h.fields)&&null!=(p=p.description)?p.value:void 0),_.isArray(e)&&e.length)for(r=0,c=e.length;r<c;r++)s=e[r],t.fields[s]=h.fields[s];else _.isPlainObject(e)&&_.assign(t.fields,h.fields);return p=angular.copy(t),o=_.find(this.cart.items,{_id:p._id}),null!=(d=p.fields)&&null!=(d=d.discountedPrice)&&null!=(d=d.value)&&d[this.currency]?p.price=p.fields.discountedPrice.value:p.price=p.fields.price.value,p.link=this.$location.url(),o?(o.name||(o.name=p.name),o.qty+=p.qty,o.qty=Math.min(o.stock,this.maxQtyPerItem||o.qty,o.qty),_.assign(o.options,p.options),_.assign(o.fields,p.fields)):this.cart.items.push(p),null!=n&&n.silent||this.$timeout((g=this,function(){return g.show=!0})),this.calculate(),this.checkCart().then((m=this,function(t){if("update"===t)return m.update()}))},e.prototype.update=function(){if(this.cart._id)return this.$rootScope.$emit("imagocart:update"),this.$http.put(this.imagoModel.host+"/api/carts/"+this.cart._id,this.cart)},e.prototype.remove=function(t){return _.remove(this.cart.items,{_id:t._id}),this.calculate(),this.update()},e.prototype.clear=function(){return this.cart.items=[],this.calculate(),this.update()},e.prototype.calculate=function(){var t,i,e,n,s,o;if(this.itemsLength=0,this.subtotal=0,this.cart.items.length){for(o=[],t=0,e=(n=this.cart.items).length;t<e;t++)i=n[t],this.itemsLength+=i.qty,i.qty&&null!=(s=i.price)&&s[this.currency]&&o.push(this.subtotal+=i.qty*i.price[this.currency]);return o}this.subtotal=0,this.itemsLength=0},e.prototype.checkout=function(){var i,e=window.debug?"/account/checkout/"+this.cart._id:"https://"+this.tenantSettings.tenant+".imago.io/account/checkout/"+this.cart._id,n="";return"function"==typeof ga&&ga((i=this,function(t){t=new i.$window.gaplugins.Linker(t);return n=t.decorate(e,!0)})),this.$window.location.href=n||e},t=e,angular.module("imago").service("imagoCart",["$q","$rootScope","$timeout","$location","$window","$http","imagoUtils","imagoModel","fulfillmentsCenter","geoIp","tenantSettings","imagoCartUtils",t])}.call(this),function(){var t,i;function e(o,t,i){var e,n,a;this.imagoCart=i,this.attrs=t(this.attributes)(),a=this,e=function(){var t,i,e,n=["findprice.imagoCart.currency","findprice.options"],s=function(t){return n.push(function(){return a.product[t]})};if(a.attrs)for(t=0,i=(e=a.attrs).length;t<i;t++)s(e[t]);return o.$watchGroup(n,function(){return a.findOpts()})},n=o.$watch("findprice.product",function(t){if(t)return n(),e()})}t=function(){return{controller:"imagoFindPriceController as findprice",bindings:{options:"=variants",product:"=",attributes:"@"},templateUrl:function(t){return t.templateUrl||"/imago/imago-find-price.html"}}},e.prototype.findOpts=function(){var t,i,e,n,s;if(this.imagoCart.currency&&null!=(n=this.options)&&n.length&&this.product){if(this.variants=_.cloneDeep(this.options),this.attrs)for(t=0,i=(s=this.attrs).length;t<i;t++)e=s[t],this.product[e]&&(this.variants=_.filter(this.variants,(i=>function(t){return i.product[e]===(null!=(t=t.fields)&&null!=(t=t[e])?t.value:void 0)})(this)));return this.findPrice()}},e.prototype.findPrice=function(){var t,i,e,n,s;for(this.prices=[],this.discounted=!1,t=0,i=(n=this.variants).length;t<i;t++)null!=(s=(e=n[t]).fields)&&null!=(s=s.discountedPrice)&&null!=(s=s.value)&&s[this.imagoCart.currency]&&(this.prices.push(e.fields.discountedPrice.value[this.imagoCart.currency]),this.discounted=!0),this.prices.push(e.fields.price.value[this.imagoCart.currency]);if(this.prices.length)return this.highest=Math.max.apply(Math,this.prices),this.lowest=Math.min.apply(Math,this.prices)},i=e,angular.module("imago").component("imagoFindPrice",new t).controller("imagoFindPriceController",["$scope","$parse","imagoCart",i])}.call(this),function(){var t=function(y,C){return t.prototype.getOptions=function(){var t,e,i,n,s,o,a,r,l,c,u,h,d,p,g,m,f,v;for(this.options={},t=0,o=(u=this.variants).length;t<o;t++)if(v=u[t],angular.isDefined(null!=(f=v.fields.price)&&null!=(f=f.value)?f[y.currency]:void 0)){for(i=0,a=(p=this.optionsWhitelist).length;i<a;i++)if(e=p[i],null!=(g=v.fields[e.name])&&g.value){for(s in c={},e)c[s]=null!=(m=v.fields)&&null!=(m=m[e[s]])?m.value:void 0;c.normname=_.kebabCase(c.name),(g=this.options)[l=e.name]||(g[l]=[]),this.options[e.name].push(c)}v.stock=Number(null!=(f=v.fields)&&null!=(f=f.stock)&&null!=(f=f.value)?f[C.selected._id]:void 0),v.presale=null!=(f=v.fields)&&null!=(f=f.presale)?f.value:void 0,v.lowstock=!!(v.stock<=this.lowStock&&v.stock)}for(s in this.options)this.options[s]=_.uniqBy(this.options[s],"name"),1===(null!=(h=this.options[s])?h.length:void 0)&&(this[s]=_.head(this.options[s]).name);for(n=0,r=(d=this.optionsWhitelist).length;n<r;n++)(e=d[n]).sortorder&&this.options[e.name]&&this.options[e.name].sort(function(t,i){return e.sortorder.indexOf(t.name)-e.sortorder.indexOf(i.name)});return this.selectVariant()},t.prototype.setOption=function(t,i){return this[t]=i,this.selectVariant()},t.prototype.findVariant=function(t,i){for(var e,n,o,a=[],s=this.optionsWhitelist,r=0,l=s.length;r<l;r++){if((n={name:(o=s[r]).name}).value=n.name===t?i:this[o.name],!n.value)return!0;a.push(n)}return!!(null!=(e=_.find(this.variants,function(t){for(var i,e=!0,n=0,s=a.length;n<s;n++)o=a[n],_.kebabCase(null!=(i=t.fields)&&null!=(i=i[o.name])?i.value:void 0)!==_.kebabCase(o.value)&&(e=!1);if(e)return!0}))&&e.stock||null!=e&&e.presale)},t.prototype.selectVariant=function(){var e,t,n,i,s={},o=!0;for(e in this.options)this[e]||(o=!1),s[e]=this[e];if(o){if(i=_.find(this.variants,(n=this,function(t){var i;for(e in o=!0,s)if(_.kebabCase(null!=(i=t.fields)&&null!=(i=i[e])?i.value:void 0)!==_.kebabCase(n[e]))return!1;return o})))return i.price=null!=(t=i.fields)&&null!=(t=t.price)?t.value:void 0,i.discountedPrice=null!=(t=i.fields)&&null!=(t=t.discountedPrice)?t.value:void 0,this.selected=i;this.selected=0}},t;function t(t,i){if(this.variants=t,null!=(t=this.variants)&&t.length&&i){for(var e in i)this[e]=i[e];if(!this.optionsWhitelist)return console.log("no optionsWhitelist set.");this.lowStock||(this.lowStock=3),this.getOptions()}}};angular.module("imago").factory("imagoProduct",["imagoCart","fulfillmentsCenter",t])}.call(this),function(){var t;function i(t,i){this.$http=t,this.imagoModel=i,this.get()}i.prototype.data=[],i.prototype.loaded=!1,i.prototype.get=function(){return this.$http.get(this.imagoModel.host+"/api/shippingmethods").then((l=this,function(t){for(var i,e,n,s,o=t.data,a=0,r=o.length;a<r;a++)for(e=0,n=(s=o[a].countries).length;e<n;e++)i=s[e],l.data.push(i);return l.data=_.sortBy(_.compact(_.uniq(l.data))),l.loaded=!0}));var l},t=i,angular.module("imago").service("shippingCountries",["$http","imagoModel",t])}.call(this),function(){var t;function i(t,i,e){this.$http=t,this.$q=i,this.imagoModel=e}i.prototype.data=[],i.prototype.search=function(t){return this.$http.get(this.imagoModel.host+"/api/variants/"+t)},i.prototype.get=function(t){var i=this.$q.defer(),e=this.imagoModel.find({_id:t}),n=_.filter(this.data,{parent:t});return(null!=e?e.variants.length:void 0)===n.length?i.resolve(n):this.search(t).then(function(t){return i.resolve(t.data)}),i.promise},t=i,angular.module("imago").service("variantsStorage",["$http","$q","imagoModel",t])}.call(this),angular.module("imago").run(["$templateCache",function(t){t.put("/imago/imago-cart-messages.html",'<div class="imago-cart-messages-content"><div ng-repeat="key in item.updates" ng-swich="key" class="message"><p ng-swich-wen="price">price has changed.</p><p ng-swich-wen="quantity">quantity has been updated.</p></div></div>'),t.put("/imago/imago-cart.html",'<div ng-class="{\'message\': cart.imagoCart.newmessages}" ng-mouseenter="cart.imagoCart.show = true" ng-click="cart.imagoCart.show = !cart.imagoCart.show" analytics-on="click" analytics-event="Show Cart {{cart.imagoCart.show}}" class="imago-cart-icon"><div ng-bind="cart.imagoCart.itemsLength" class="counter"></div></div><div ng-show="cart.imagoCart.show" stop-scroll="stop-scroll" class="imago-cart-modal"><div ng-transclude="ng-transclude"></div><div class="imago-cart-messages"><div ng-repeat="message in cart.imagoCart.messages" ng-switch="message.type" class="message"><p ng-switch-when="nostock">Item {{message.item.name}} is not in stock anymore</p></div></div><div ng-show="cart.imagoCart.itemsLength" class="itemnumber">{{cart.imagoCart.itemsLength}}<span ng-show="cart.imagoCart.itemsLength === 1"> item</span><span ng-show="cart.imagoCart.itemsLength &gt; 1"> items</span></div><div ng-show="cart.imagoCart.itemsLength === 0 &amp;&amp; !cart.imagoCart.messages.length" class="noitems">cart empty</div><div ng-show="cart.imagoCart.itemsLength" class="subtotal">subtotal:<span ng-bind-html="cart.imagoCart.currency | currencySymbol" class="currency"></span><span class="amount">{{cart.imagoCart.subtotal | price:0}}</span></div><button ng-show="cart.imagoCart.cart.items.length" type="button" ng-click="cart.imagoCart.checkout()" analytics-on="click" analytics-event="Go to Checkout" class="checkout">checkout</button></div>'),t.put("/imago/imago-find-price.html",'<div ng-if="findprice.highest || findprice.lowest" class="imago-find-price-content"><div ng-show="findprice.highest === findprice.lowest" class="one-price"><span ng-bind-html="findprice.imagoCart.currency | currencySymbol" class="currency"></span><span ng-bind="findprice.highest | price: 0" class="amount"></span></div><div ng-show="findprice.highest !== findprice.lowest" ng-class="{\'discount\': findprice.discounts.length, \'range\': !findprice.discounts.length}"><span ng-bind-html="findprice.imagoCart.currency" class="currency low"></span><span ng-bind="findprice.lowest | price: 0" class="amount low"></span><span class="dash">-</span><span ng-bind-html="findprice.imagoCart.currency" class="currency high"></span><span ng-bind="findprice.highest | price: 0" class="amount high"></span></div></div>')}]);