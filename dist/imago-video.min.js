var imagoControls,imagoControlsController;imagoControls=function(){function e(){return{replace:!0,require:"^imagoVideo",templateUrl:"/imago/controls-video.html",controller:"imagoControlsController as imagocontrols",link:function(e,o,i){return e.seek=function(o){return e.imagovideo.player.currentTime=o},e.onVolumeChange=function(o){return function(o){return e.imagovideo.player.volume=parseFloat(o/100)}}(this),e.volumeDown=function(o){return function(){return e.imagovideo.player.volume=0,e.volumeInput=0}}(this),e.volumeUp=function(o){return function(){return e.imagovideo.player.volume=1,e.volumeInput=100}}(this),e.fullScreen=function(o){return function(){return e.imagovideo.player.requestFullscreen?e.imagovideo.player.requestFullscreen():e.imagovideo.player.webkitRequestFullscreen?e.imagovideo.player.webkitRequestFullscreen():e.imagovideo.player.mozRequestFullScreen?e.imagovideo.player.mozRequestFullScreen():e.imagovideo.player.msRequestFullscreen?e.imagovideo.player.msRequestFullscreen():void 0}}(this),o.bind("mouseup",function(e){return e.stopPropagation()}),o.bind("mousedown",function(e){return e.stopPropagation()})}}}return e}(),imagoControlsController=function(){function e(e){var o;o=angular.element(e.imagovideo.player),e.currentTime=0,o.bind("loadeddata",function(o){return e.duration=parseInt(o.target.duration),e.$digest()}),o.bind("timeupdate",function(o){return e.currentTime=o.target.currentTime,e.$digest()}),o.bind("seeking",function(o){return e.currentTime=o.target.currentTime,e.$digest()})}return e}(),angular.module("imago").directive("imagoControls",[imagoControls]).controller("imagoControlsController",["$scope",imagoControlsController]);var imagoVideo,imagoVideoController;imagoVideo=function(){function e(e,o,i,t){return{replace:!0,scope:!0,templateUrl:"/imago/imago-video.html",controller:"imagoVideoController as imagovideo",link:function(n,a,r){var l,s,u,c,d,p,g,m,v,f,h,y,w,b,z;f={},n.source=void 0,n.visible=!1,g={autobuffer:null,autoplay:!1,controls:!0,preload:"none",size:"hd",align:"center center",sizemode:"fit",lazy:!0,hires:!0,loop:!1,width:"",height:""};for(c in r)b=r[c],"true"===b||"false"===b?g[c]=JSON.parse(b):"width"===c||"height"===c?g[c]="auto"===b?b:parseInt(b):g[c]=b;return u=/[0-9a-fA-F]{24}/,r.imagoVideo.match(u)?f.watch=r.$observe("imagoVideo",function(e){return e?(n.source=t.find({_id:e}),r.watch||f.watch(),l()):void 0}):f.watch=n.$watch(r.imagoVideo,function(e){return function(e){return e?(n.source=e,r.watch||f.watch(),l()):void 0}}(this)),l=function(){var e,o,i,t;return(null!=(e=n.source.fields)&&null!=(o=e.formats)?o.length:void 0)?((null!=(i=n.source.fields)?i.hasOwnProperty("crop"):void 0)&&!r.align&&(g.align=n.source.fields.crop.value),(null!=(t=n.source.fields)?t.hasOwnProperty("sizemode"):void 0)&&("default"===n.source.fields.sizemode.value||r.sizemode||(g.sizemode=n.source.fields.sizemode.value)),m()):console.log("no formats found")},m=function(){var e,o,i,t,r,l,s;return angular.isString(n.source.resolution)&&(i=n.source.resolution.split("x"),t={width:i[0],height:i[1]},g.assetRatio=i[0]/i[1]),n.controls=g.controls,g.width&&g.height?(s=g.width,o=g.height):(s=a[0].clientWidth,o=a[0].clientHeight),e=g.hires?Math.ceil(window.devicePixelRatio)||1:1,n.source.serving_url&&(r=n.source.serving_url+"=s"+(Math.ceil(Math.min(Math.max(s,o)*e))||1600)),l={size:g.size,sizemode:g.sizemode,backgroundPosition:g.align,backgroundRepeat:"no-repeat"},r&&(l.backgroundImage="url("+r+")"),n.wrapperStyle=l,h(),n.videoFormats=d(),v(s,o,r)},h=function(){return g.autoplay===!0&&n.imagovideo.player.setAttribute("autoplay",!0),n.imagovideo.player.setAttribute("preload",g.preload),n.imagovideo.player.setAttribute("x-webkit-airplay","allow"),n.imagovideo.player.setAttribute("webkitAllowFullscreen",!0),g.loop===!0?n.imagovideo.player.setAttribute("loop",g.loop):void 0},v=function(o){return function(o,i,t){var a,l;return g.lazy&&!n.visible?f.visibleFunc=n.$watch(r.visible,function(e){return n.visible=e,e?(f.visibleFunc(),v(o,i,t)):void 0}):(l=function(){return e(function(){return _.assign(n.wrapperStyle,w(o,i)),n.videoStyle=y(o,i),n.loading=!1})},a=angular.element("<img>"),a.on("load",l),t?a[0].src=t:l())}}(this),w=function(e,o){var i,t;if(e&&o)return i={},t=e/o,"crop"===g.sizemode?g.assetRatio<t?i.backgroundSize="100% auto":i.backgroundSize="auto 100%":g.assetRatio<t?(i.width=Math.round(o*g.assetRatio)+"px",i.height=o+"px",i.backgroundSize="auto 100%"):(i.width=e+"px",i.height=Math.round(e/g.assetRatio)+"px",i.backgroundSize="100% auto"),i},y=function(e){return function(e,o){var t,n;if(e&&o)return t={},n=e/o,i.isiOS()?(t.width="100%",t.height="100%","center center"===g.align&&"crop"===g.sizemode&&(t.top="0",t.left="0")):"crop"===g.sizemode?g.assetRatio<n?(t.width="100%",t.height="auto","center center"===g.align&&(t.top="50%",t.left="auto",t.marginTop="-"+Math.round(o/2)+"px",t.marginLeft="0px")):(t.width="auto",t.height="100%","center center"===g.align&&(t.top="auto",t.left="50%",t.marginTop="0px",t.marginLeft="-"+Math.round(e/2)+"px")):g.assetRatio<n?(t.width="auto",t.height="100%"):(t.width="100%",t.height="auto"),t}}(this),d=function(){var e,o,i,t,a,r,l,u;for(i=[],e=s(),n.source.fields.formats.sort(function(e,o){return o.height-e.height}),t="online"===data?"api.imago.io":"localhost:8000",u=n.source.fields.formats,a=r=0,l=u.length;l>r;a=++r)o=u[a],e===o.codec&&i.push({src:"//"+t+"/api/play_redirect?uuid="+n.source.uuid+"&codec="+o.codec+"&quality=hd&max_size="+o.size,size:o.size,codec:o.codec,type:"video/"+e});return i},s=function(){var e;if(n.imagovideo.player.canPlayType){e={mp4:'video/mp4; codecs="mp4v.20.8"',mp4:'video/mp4; codecs="avc1.42E01E"',mp4:'video/mp4; codecs="avc1.42E01E, mp4a.40.2"',webm:'video/webm; codecs="vp8, vorbis"',ogg:'video/ogg; codecs="theora"'};for(c in e)if(b=e[c],n.imagovideo.player.canPlayType(b))return c}},n.toggleSize=function(){return"hd"===g.size?(g.size="sd",n.wrapperStyle.size="sd"):(g.size="hd",n.wrapperStyle.size="hd"),n.videoFormats.reverse(),e(function(){return n.imagovideo.player.load(),n.imagovideo.player.play()})},p=function(){var e,o;return o=a[0].clientWidth||g.width,e=a[0].clientHeight||g.height,_.assign(n.wrapperStyle,w(o,e)),n.videoStyle=y(o,e),n.$apply()},z={},z.resize=o.$on("resize",p),z.resizestop=o.$on("resizestop",function(){return m(n.source)}),z.action=o.$on("imagovideo:action",function(e,o){var i;if(!o.id!==n.source._id&&o.action&&_.isFunction(null!=(i=n.imagovideo.player)?i[o.action]:void 0))return n.imagovideo.player[o.action]()}),n.$on("$destroy",function(){var e;e=[];for(c in z)e.push(z[c]());return e}),n.$on("$stateChangeSuccess",function(){return e(function(){var e;return document.createEvent?(e=new Event("checkInView"),window.dispatchEvent(e)):(e=document.createEventObject(),e.eventType="checkInView",e.eventName="checkInView",window.fireEvent("on"+e.eventType,e))})})}}}return e}(),imagoVideoController=function(){function e(e,o,i){this.player=o.find("video")[0],e.loading=!0,angular.element(this.player).bind("ended",function(e){return function(o){return e.player.currentTime=0,e.state="end"}}(this)),angular.element(this.player).bind("loadeddata",function(o){return function(){return e.hasPlayed=!0,angular.element(o.player).unbind("loadeddata")}}(this)),angular.element(this.player).bind("play",function(e){return function(){return e.state="playing"}}(this))}return e.prototype.togglePlay=function(){return this.player.paused?(this.state="playing",this.player.play()):(this.state="paused",this.player.pause())},e}(),angular.module("imago").directive("imagoVideo",["$timeout","$rootScope","imagoUtils","imagoModel",imagoVideo]).controller("imagoVideoController",["$scope","$element","$attrs",imagoVideoController]);var Time;Time=function(){function e(){return function(e){var o,i,t,n,a;if("number"==typeof e)return n=function(e){return 10>e?"0"+e:e},o=[],t=Math.floor(e/60),i=Math.floor(e/3600),a=0===e?0:e%60,a=Math.round(a),i>0&&o.push(n(i)),o.push(n(t)),o.push(n(a)),o.join(":")}}return e}(),angular.module("imago").filter("time",[Time]),angular.module("imago").run(["$templateCache",function(e){e.put("/imago/controls-video.html",'<div stop-propagation="stop-propagation" class="controls"><a ng-click="imagovideo.togglePlay()" ng-class="{\'fa-pause\': imagovideo.state === \'playing\', \'fa-play\': imagovideo.state === \'paused\'}" analytics-on="click" analytics-event="Video {{ imagovideo.state }}" class="video-play fa fa-play"></a><span class="video-time">{{currentTime | time}}</span><span class="video-seekbar"><input type="range" ng-model="currentTime" min="0" max="{{duration}}" ng-change="seek(currentTime)" class="seek"/></span><a ng-click="toggleSize()" class="size">{{wrapperStyle.size}}</a><span class="volume"><span ng-click="volumeUp()" class="fa fa-volume-up icon-volume-up"></span><input type="range" ng-model="volumeInput" ng-change="onVolumeChange(volumeInput)"/><span ng-click="volumeDown()" class="fa fa-volume-down icon-volume-down"></span></span><a ng-click="fullScreen()" analytics-on="click" analytics-event="Video Full Screen" class="video-fullscreen fa fa-expand"></a><a class="video-screen fa fa-compress"></a></div>'),e.put("/imago/imago-video.html",'<div ng-class="{loading: loading}" in-view="visible = $inview" visible="visible" responsive-events="responsive-events" class="imagovideo {{wrapperStyle.backgroundPosition}} {{wrapperStyle.size}} {{wrapperStyle.sizemode}}"><div ng-style="wrapperStyle" ng-class="imagovideo.state" class="imagowrapper"><a ng-hide="loading" ng-click="imagovideo.togglePlay()" ng-class="{playing: imagovideo.isPlaying}" stop-propagation="stop-propagation" analytics-on="click" analytics-event="Video Play Big" class="playbig fa fa-play"></a><video ng-style="videoStyle"><source ng-repeat="format in videoFormats" src="{{format.src}}" data-size="{{format.size}}" data-codec="{{format.codec}}" type="{{format.type}}"/></video><div imago-controls="imago-controls" ng-style="controlStyle" ng-show="controls &amp;&amp; hasPlayed"></div></div></div>')}]);