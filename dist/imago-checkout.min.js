!function(){var t=function(f,t){return{require:"ngModel",link:function(h,t,p,u){var l,d,g;return"undefined"!=typeof google&&null!==google&&google.maps?p.autocompleteGoogle?(l=new google.maps.places.Autocomplete(t[0],{types:["geocode"]}),google.maps.event.addDomListener(t[0],"keydown",function(t){if(13===t.keyCode)return t.preventDefault()}),0,google.maps.event.addListener(l,"place_changed",function(){var t,i,e,n,s,o,r,a,c;if((d=l.getPlace()).address_components){for(n=f(p.autocompleteGoogle)(h),g=d.name||u.$viewValue,t={locality:{label:"city",value:"long_name"},administrative_area_level_1:{label:"state",value:"short_name"},country:{label:"country",value:"long_name"},postal_code:{label:"zip",value:"short_name"}},i={},s=0,r=(a=d.address_components).length;s<r;s++)t[c=(e=a[s]).types[0]]&&(i[t[c].label]=e[t[c].value]||"");for(o in i)n[o]=i[o];return p.autocompleteOnsuccess&&f(p.autocompleteOnsuccess)(h),h.$apply(function(){return u.$setViewValue(g),u.$render()})}})):console.log("you need a form to fill. Use the options attribute"):console.log("the google library is not loaded")}}};angular.module("imago").directive("autocompleteGoogle",["$parse","imagoUtils",t])}.call(this),function(){function r(t,i){return function(){return t.apply(i,arguments)}}var t,p=[].indexOf||function(t){for(var i=0,e=this.length;i<e;i++)if(i in this&&this[i]===t)return i;return-1};function i(t,i,e,n,s,o){this.$q=t,this.$state=i,this.$http=e,this.$auth=n,this.imagoUtils=s,this.imagoModel=o,this.submit=r(this.submit,this),this.calculate=r(this.calculate,this),this.calculateTotal=r(this.calculateTotal,this),this.getZipTax=r(this.getZipTax,this),this.getTaxRate=r(this.getTaxRate,this),this.calcShipping=r(this.calcShipping,this),this.calculateShipping=r(this.calculateShipping,this),this.changeShipping=r(this.changeShipping,this),this.findShippingRate=r(this.findShippingRate,this),this.getShippingRate=r(this.getShippingRate,this),this.setShippingRates=r(this.setShippingRates,this),this.setCurrency=r(this.setCurrency,this),this.applyCoupon=r(this.applyCoupon,this),this.checkCoupon=r(this.checkCoupon,this),this.changeAddress=r(this.changeAddress,this),this.deleteItem=r(this.deleteItem,this),this.updateCart=r(this.updateCart,this),this.countries=this.imagoUtils.COUNTRIES}i.prototype.cart=void 0,i.prototype.costs={},i.prototype.coupon=void 0,i.prototype.stripe=void 0,i.prototype.currency=void 0,i.prototype.shippingmethods=void 0,i.prototype.taxes=void 0,i.prototype.currencies=void 0,i.prototype.taxincluded=void 0,i.prototype.error={},i.prototype.updateCart=function(){return this.$http.put(this.imagoModel.host+"/api/carts/"+this.cart._id,this.cart),this.calculate()},i.prototype.deleteItem=function(t){return _.remove(this.cart.items,{_id:t._id}),this.updateCart()},i.prototype.changeAddress=function(t,i){var e,n,s,o,r,a;for(null!=(r=this.form.shipping_address)&&r.country&&this.differentshipping&&"country"===i?this.setCurrency(null,this.form.shipping_address.country):"country"===i&&this.setCurrency(null,this.form[t].country),e=0,n=(s=["billing_address","shipping_address"]).length;e<n;e++)this[a=s[e]]||(this[a]={}),(o=this.form)[a]||(o[a]={}),"United States of America"===(o=this.form[a].country)||"United States"===o||"USA"===o||"Canada"===o||"Australia"===o?(this[a].disablestates=!1,"United States of America"===(o=this.form[a].country)||"United States"===o||"USA"===o?this[a].states=this.imagoUtils.STATES.USA:this[a].states=this.imagoUtils.STATES[this.form[a].country.toUpperCase()]):(this[a].disablestates=!0,this[a].states=[]),this.form[a].country_code=this.imagoUtils.CODES[this.form[a].country];return null!=(r=this.form.shipping_address)&&r.country&&this.differentshipping?(this.country=this.form.shipping_address.country,this.state=this.form.shipping_address.state,this.zip=this.form.shipping_address.zip):(this.country=this.form[t].country,this.state=this.form[t].state,this.zip=this.form[t].zip),this.calculate()},i.prototype.checkCoupon=function(t){var i,e;{if(t)return t=this.imagoModel.host+"/api/coupons?code="+t,null!=(i=this.form)&&null!=(i=i.user)&&i.email&&(t+="&email="+this.form.user.email),this.$http.get(t).then((e=this,function(t){return 1===t.data.length?(e.coupon=_.head(t.data),e.couponState="valid"):(e.coupon=null,e.couponState="invalid"),e.calculate()}));this.coupon=null,this.couponState=null,this.calculate()}},i.prototype.applyCoupon=function(t,i){var e,n;if(t)return t=t.meta,this.couponState="valid","flat"===t.type?(n=Math.min(i.subtotal,t.value[this.currency]),i.discount=n):"percent"===t.type?(n=Number((i.subtotal*t.value/100).toFixed(0)),i.discount=n):"free shipping"===t.type?(i.discount=null,n=t.shippingMethods||[],!(t.limitByShippings&&(e=this.shipping_options._id.toString(),0<=p.call(n,e)))&&t.limitByShippings?this.couponState="invalid":i.shipping=0):void 0;i.discount=null},i.prototype.setCurrency=function(t,i){var e=angular.copy(this.currency);if(i&&(t=this.imagoUtils.inUsa(i)?"USD":this.imagoUtils.CURRENCY_MAPPING[i]),this.currency=0<=p.call(this.currencies,t)?t:this.currencies[0],e!==this.currency)return this.saveCart()},i.prototype.setShippingRates=function(t){var e;if(null!=t&&t.length?(t=(t=_.isPlainObject(t)?[t]:t).sort((e=this,function(t,i){return(null!=(t=t.ranges[0].price)?t[e.currency]:void 0)-(null!=(t=i.ranges[0].price)?t[e.currency]:void 0)})),this.shippingRates=t):this.shippingRates=[],this.shippingRates.length)return this.shipping_options=this.shippingRates[0]},i.prototype.getShippingRate=function(){var t=this.$q.defer(),i=this.findShippingRate();return t.resolve(i),t.promise},i.prototype.findShippingRate=function(){var t,i,e,n;if(this.country)return this.imagoUtils.inUsa(this.country)&&(this.country="United States"),i=_.filter(this.shippingmethods,(e=this,function(s){var o,t;return s.active&&(t=null!=(t=e.country)?t.toUpperCase():void 0,0<=p.call(function(){for(var t=s.countries,i=[],e=0,n=t.length;e<n;e++)o=t[e],i.push(o.toUpperCase());return i}(),t))})),this.state?null!=(t=_.filter(i,(n=this,function(s){var o,t=n.state.toUpperCase();return 0<=p.call(function(){for(var t=s.states,i=[],e=0,n=t.length;e<n;e++)o=t[e],i.push(o.toUpperCase());return i}(),t)})))&&t.length||(t=_.filter(i,function(t){return!t.states.length})).length?t:_.filter(this.shippingmethods,function(t){return!t.countries.length}):i.length?i:_.filter(this.shippingmethods,function(t){return!t.countries.length})},i.prototype.changeShipping=function(){return this.calcShipping(this.shipping_options).then((i=this,function(t){return i.costs.shipping=t.shipping,i.calculate()}));var i},i.prototype.calculateShipping=function(){return this.$q((r=this,function(o,t){return r.calculateShippingRunning?t():(r.calculateShippingRunning=!0,r.costs.shipping=0,r.getShippingRate().then(function(e){var t,i,n,s;if(r.calculateShippingRunning=!1,null==e||!e.length)return r.shipping_options=void 0,r.shippingRates=[],r.country&&(r.error.noshippingrule=!0),o();for(r.error.noshippingrule=!1,s=[],t=0,i=e.length;t<i;t++)n=e[t],s.push(r.calcShipping(n).then(function(t){var i;if(r.shipping_options&&r.shipping_options._id===t.rate._id?(r.costs.shipping=t.shipping,o()):r.shipping_options&&!_.difference(r.shippingRates,e).length||(r.setShippingRates(e),r.costs.shipping=t.shipping,o()),null!=(i=r.shippingRates)&&i.length)return i=(t.shipping/100).toFixed(2),(t=_.find(r.shippingRates,{_id:t.rate._id})).nameprice=t.name+" ("+r.currency+" "+i+")"}));return s}))}));var r},i.prototype.calcShipping=function(g){return this.$q((f=this,function(t,i){for(var e,n,s,o,r,a,c=0,h=[],p=0,u=f.cart.items,l=0,d=u.length;l<d;l++)null!=(o=(e=u[l]).fields.overwriteShippingCosts)&&null!=(o=o.value)&&o[f.currency]?h.push(e):null!=(o=e.fields.calculateShippingCosts)&&o.value&&("weight"===g.type?c+=((null!=(o=e.fields.weight)?o.value:void 0)||1)*e.qty:c+=e.qty);if(0===c&&"weight"!==g.type&&!h.length)return t({shipping:0,rate:g});for(r=(r=_.find(g.ranges,function(t){return c<=t.to_unit&&c>=t.from_unit}))||_.last(g.ranges),c&&(p=null!=(r=r.price)?r[f.currency]:void 0),n=0,s=h.length;n<s;n++)p+=((null!=(a=(e=h[n]).fields.overwriteShippingCosts)&&null!=(a=a.value)?a[f.currency]:void 0)||0)*e.qty;return t({shipping:p,rate:g})}));var f},i.prototype.calculateTax=function(){return this.getTaxRate().then((u=this,function(){var t,i,e,n,s,o,r,a,c,h,p;if(u.costs.tax=0,!u.imagoUtils.includesTax(u.currency)){for(e=p=0,s=(a=u.cart.items).length;e<s;e++)null!=(c=(i=a[e]).fields.calculateTaxes)&&c.value&&i.price[u.currency]&&(p+=Math.round(i.price[u.currency]*i.qty));return"percent"===(null!=(h=u.coupon)?h.meta.type:void 0)&&u.coupon.meta.value&&(p-=p*u.coupon.meta.value/100),u.costs.tax=Math.round(p*u.costs.taxRate),u.costs.tax}if(u.costs.includedTax=0,u.costs.taxRate)for(t=0,n=(o=u.cart.items).length;t<n;t++)null!=(r=(i=o[t]).fields.calculateTaxes)&&r.value&&(r=i.price[u.currency]/(100+100*u.costs.taxRate)*i.qty,u.costs.includedTax+=r*u.costs.taxRate*100)}));var u},i.prototype.getTaxRate=function(){return this.$q((e=this,function(t){var i;return e.costs.taxRate=0,e.country?(i=e.findTaxRate()).autotax&&e.imagoUtils.inUsa(e.country)?void e.getZipTax().then(function(){return t()}):(e.costs.taxRate=i.rate/100,t()):t()}));var e},i.prototype.findTaxRate=function(){var t,i,e,n;return this.country?("United States of America"!==(t=this.country)&&"USA"!==t||(this.country="United States"),(t=_.filter(this.taxes,(e=this,function(s){var o,t;return s.active&&(t=null!=(t=e.country)?t.toUpperCase():void 0,0<=p.call(function(){for(var t=s.countries,i=[],e=0,n=t.length;e<n;e++)o=t[e],i.push(o.toUpperCase());return i}(),t))}))).length||(t=_.filter(this.taxes,function(t){return t.active&&!t.countries.length})),this.state?_.find(t,(n=this,function(s){var o,t=n.state.toUpperCase();return 0<=p.call(function(){for(var t=s.states,i=[],e=0,n=t.length;e<n;e++)o=t[e],i.push(o.toUpperCase());return i}(),t)}))||(null!=(i=_.filter(t,function(t){return 0===t.states.length}))?i[0]:void 0)||{rate:0}:null==t||!t[0]||null!=(i=t[0].states)&&i.length?{rate:0}:null!=t?t[0]:void 0):{rate:0}},i.prototype.getZipTax=function(){return this.$q((e=this,function(i){var t;return e.zip||4<(null!=(t=e.zip)?t.length:void 0)?e.$http.get(e.imagoModel.host+"/api/ziptax?zipcode="+e.zip).then(function(t){return e.costs.taxRate=t.data.taxUse,i()}):i()}));var e},i.prototype.calculateTotal=function(){return this.costs.total=0,this.costs.subtotal&&(this.costs.total+=this.costs.subtotal),this.costs.discount&&(this.costs.total-=this.costs.discount),this.costs.shipping&&(this.costs.total+=this.costs.shipping),this.costs.tax&&(this.costs.total+=this.costs.tax),this.costs.total},i.prototype.checkStock=function(t){var i,e,n,s,o,r,a,c,h;if(this.cartError={},this.fcenter=_.find(this.fulfillmentcenters,(h=this,function(t){var i=h.country;return 0<=p.call(t.countries,i)})),this.fcenter||(this.fcenter=_.find(this.fulfillmentcenters,function(t){return!t.countries.length})),this.fcenter&&(i=!1,null!=(o=this.cart.items))&&o.length){for(e=0,s=(r=this.cart.items).length;e<s;e++)n=r[e],c=_.isUndefined(null!=(c=n.fields.stock)&&null!=(c=c.value)?c[this.fcenter._id]:void 0)?1e5:null!=(c=n.fields.stock)&&null!=(c=c.value)?c[this.fcenter._id]:void 0,parseInt(c)<n.qty&&(null==(a=n.fields)||null==(a=a.presale)||!a.value)&&(n.qty=_.max([c,0]),i=!0,0!==c&&(this.cartError[n._id]={maxStock:!0}),c<=0)&&(this.cartError[n._id]={noStock:!0});i&&this.$http.put(this.imagoModel.host+"/api/carts/"+this.cart._id,this.cart)}return t()},i.prototype.calculate=function(){return this.checkStock((o=this,function(){var t,i,e,n,s;if(o.costs={subtotal:0,shipping:0,tax:0,includedTax:0,total:0},null!=(n=o.cart.items)&&n.length){for(t=0,e=(s=o.cart.items).length;t<e;t++)(i=s[t]).price[o.currency]&&i.qty&&(o.costs.subtotal+=i.qty*i.price[o.currency]);o.costs.total=o.costs.subtotal}return o.$q.all([o.calculateTax(),o.calculateShipping()]).then(function(){return o.coupon&&o.applyCoupon(o.coupon,o.costs),o.calculateTotal(),o.finalCosts=angular.copy(o.costs)})}));var o},i.prototype.formatForm=function(t){var i;return t.costs=angular.copy(this.costs),t.costs.shipping_options=angular.copy(this.shipping_options),t.costs.coupon=angular.copy(this.coupon)||null,t.shipping_address||(t.shipping_address={}),t.billing_address.phone=angular.copy(this.form.phone),t.shipping_address.phone=angular.copy(this.form.phone),t.fulfillmentcenter=angular.copy(null!=(i=this.fcenter)?i._id:void 0),t.userData={browser:null!=(i=window.navigator)?i.userAgent:void 0},this.differentshipping||(t.shipping_address=angular.copy(this.form.billing_address)),t},i.prototype.submit=function(){var t;return this.form.items=angular.copy(this.cart.items),this.form.currency=angular.copy(this.currency),this.form.cartId=angular.copy(this.cart._id),this.form.billing_address.name=angular.copy(null!=(t=this.form.user)?t.name:void 0),this.form=this.formatForm(this.form),this.$http.post(this.imagoModel.host+"/api/checkout",this.form)},i.prototype.saveCart=function(t){var i=angular.copy(this.cart);return i.currency=this.currency,i.data=angular.copy(this.form),i.data.paymentType=angular.copy(this.paymentType),i.data.differentshipping=this.differentshipping,i.data=this.formatForm(i.data),t?(i=angular.toJson(i),(t=new XMLHttpRequest).open("PUT",this.imagoModel.host+"/api/carts/"+this.cart._id,!1),t.setRequestHeader("Content-type","application/json"),t.send(i)):this.$http.put(this.imagoModel.host+"/api/carts/"+this.cart._id,i)},t=i,angular.module("imago").service("calculation",["$q","$state","$http","$auth","imagoUtils","imagoModel",t])}.call(this),function(){var t=function(){return{scope:{costs:"=",currency:"=",hideIfNotCountry:"=?"},templateUrl:"/imago/costs.html",controller:"costsController as costs"}},i=function(i,t,e){e.hideIfNotCountry?i.hideIfNotCountry||i.$watch("hideIfNotCountry",function(t){return i.hideCountryDefined=angular.isDefined(t)}):(i.hideIfNotCountry=!1,i.hideCountryDefined=!0)};angular.module("imago").directive("costs",[t]).controller("costsController",["$scope","$element","$attrs",i])}.call(this),angular.module("imago").run(["$templateCache",function(t){t.put("/imago/costs.html",'<table><tbody><tr><th>Subtotal</th><td><span ng-bind-html="currency | currencySymbol" class="currency"></span>{{ costs.subtotal | price }}</td></tr><tr ng-show="costs.discount"><th>Discount</th><td><span ng-bind-html="currency | currencySymbol" class="currency"></span>- {{ costs.discount | price }}</td></tr><tr ng-show="!hideIfNotCountry &amp;&amp; hideCountryDefined"><th>Shipping</th><td ng-show="costs.shipping"><span ng-bind-html="currency | currencySymbol" class="currency"></span>{{ costs.shipping | price }}</td><td ng-hide="costs.shipping">free</td></tr><tr ng-show="costs.includedTax &amp;&amp; !hideIfNotCountry &amp;&amp; hideCountryDefined"><th>Included Tax</th><td><span ng-bind-html="currency | currencySymbol" class="currency"></span>{{ costs.includedTax | price }}</td></tr><tr ng-show="!costs.includedTax &amp;&amp; !hideIfNotCountry &amp;&amp; hideCountryDefined"><th>Tax</th><td><span ng-bind-html="currency | currencySymbol" class="currency"></span>{{ costs.tax | price }}</td></tr><tr class="total"><th>Total</th><td><span ng-bind-html="currency | currencySymbol" class="currency"></span>{{ costs.total | price }}</td></tr></tbody></table>')}]);