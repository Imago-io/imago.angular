(function(){var t;t=function(){function t(t,i){return{require:"ngModel",link:function(i,n,e,s){var o,r,a;return("undefined"!=typeof google&&null!==google?google.maps:void 0)?e.autocompleteGoogle?(o=new google.maps.places.Autocomplete(n[0],{types:["geocode"]}),google.maps.event.addDomListener(n[0],"keydown",function(t){if(13===t.keyCode)return t.preventDefault()}),a=void 0,r=void 0,google.maps.event.addListener(o,"place_changed",function(){var n,c,u,h,p,l,d,g,f,y;if(r=o.getPlace(),r.address_components){for(h=t(e.autocompleteGoogle)(i),a=r.name||s.$viewValue,n={locality:{label:"city",value:"long_name"},administrative_area_level_1:{label:"state",value:"short_name"},country:{label:"country",value:"long_name"},postal_code:{label:"zip",value:"short_name"}},c={},g=r.address_components,p=0,d=g.length;p<d;p++)u=g[p],f=u.types[0],n[f]&&(c[n[f].label]=u[n[f].value]||"");for(l in c)y=c[l],h[l]=y;return e.autocompleteOnsuccess&&t(e.autocompleteOnsuccess)(i),i.$apply(function(){return s.$setViewValue(a),s.$render()})}})):console.log("you need a form to fill. Use the options attribute"):console.log("the google library is not loaded")}}}return t}(),angular.module("imago").directive("autocompleteGoogle",["$parse","imagoUtils",t])}).call(this),function(){var t,i=function(t,i){return function(){return t.apply(i,arguments)}},n=[].indexOf||function(t){for(var i=0,n=this.length;i<n;i++)if(i in this&&this[i]===t)return i;return-1};t=function(){function t(t,n,e,s,o,r){this.$q=t,this.$state=n,this.$http=e,this.$auth=s,this.imagoUtils=o,this.imagoModel=r,this.submit=i(this.submit,this),this.calculate=i(this.calculate,this),this.calculateTotal=i(this.calculateTotal,this),this.getZipTax=i(this.getZipTax,this),this.getTaxRate=i(this.getTaxRate,this),this.calcShipping=i(this.calcShipping,this),this.calculateShipping=i(this.calculateShipping,this),this.changeShipping=i(this.changeShipping,this),this.findShippingRate=i(this.findShippingRate,this),this.getShippingRate=i(this.getShippingRate,this),this.setShippingRates=i(this.setShippingRates,this),this.setCurrency=i(this.setCurrency,this),this.applyCoupon=i(this.applyCoupon,this),this.checkCoupon=i(this.checkCoupon,this),this.changeAddress=i(this.changeAddress,this),this.deleteItem=i(this.deleteItem,this),this.updateCart=i(this.updateCart,this),this.countries=this.imagoUtils.COUNTRIES}return t.prototype.cart=void 0,t.prototype.costs={},t.prototype.coupon=void 0,t.prototype.stripe=void 0,t.prototype.currency=void 0,t.prototype.shippingmethods=void 0,t.prototype.taxes=void 0,t.prototype.currencies=void 0,t.prototype.taxincluded=void 0,t.prototype.error={},t.prototype.updateCart=function(){return this.$http.put(this.imagoModel.host+"/api/carts/"+this.cart._id,this.cart),this.calculate()},t.prototype.deleteItem=function(t){return _.remove(this.cart.items,{id:t.id}),this.updateCart()},t.prototype.changeAddress=function(t,i){var n,e,s,o,r,a,c,u,h;for((null!=(o=this.form.shipping_address)?o.country:void 0)&&this.differentshipping&&"country"===i?this.setCurrency(null,this.form.shipping_address.country):"country"===i&&this.setCurrency(null,this.form[t].country),r=["billing_address","shipping_address"],e=0,s=r.length;e<s;e++)h=r[e],this[h]||(this[h]={}),(n=this.form)[h]||(n[h]={}),"United States of America"===(a=this.form[h].country)||"United States"===a||"USA"===a||"Canada"===a||"Australia"===a?(this[h].disablestates=!1,"United States of America"===(c=this.form[h].country)||"United States"===c||"USA"===c?this[h].states=this.imagoUtils.STATES.USA:this[h].states=this.imagoUtils.STATES[this.form[h].country.toUpperCase()]):(this[h].disablestates=!0,this[h].states=[]),this.form[h].country_code=this.imagoUtils.CODES[this.form[h].country];return(null!=(u=this.form.shipping_address)?u.country:void 0)&&this.differentshipping?(this.country=this.form.shipping_address.country,this.state=this.form.shipping_address.state,this.zip=this.form.shipping_address.zip):(this.country=this.form[t].country,this.state=this.form[t].state,this.zip=this.form[t].zip),this.calculate()},t.prototype.checkCoupon=function(t){var i,n,e;return t?(e=this.imagoModel.host+"/api/coupons?code="+t,(null!=(i=this.form)&&null!=(n=i.user)?n.email:void 0)&&(e+="&email="+this.form.user.email),this.$http.get(e).then(function(t){return function(i){return 1===i.data.length?(t.coupon=_.head(i.data),t.couponState="valid"):(t.coupon=null,t.couponState="invalid"),t.calculate()}}(this))):(this.coupon=null,this.couponState=null,void this.calculate())},t.prototype.applyCoupon=function(t,i){var e,s,o,r,a;return t?(s=t.meta,this.couponState="valid","flat"===s.type?(a=Math.min(i.subtotal,s.value[this.currency]),i.discount=a):"percent"===s.type?(o=Number((i.subtotal*s.value/100).toFixed(0)),i.discount=o):"free shipping"===s.type?(i.discount=null,e=s.shippingMethods||[],s.limitByShippings&&(r=this.shipping_options._id.toString(),n.call(e,r)>=0)?i.shipping=0:s.limitByShippings?this.couponState="invalid":i.shipping=0):void 0):void(i.discount=null)},t.prototype.setCurrency=function(t,i){var e;if(e=angular.copy(this.currency),i&&(t=this.imagoUtils.inUsa(i)?"USD":this.imagoUtils.CURRENCY_MAPPING[i]),this.currency=n.call(this.currencies,t)>=0?t:this.currencies[0],e!==this.currency)return this.saveCart()},t.prototype.setShippingRates=function(t){if((null!=t?t.length:void 0)?(t=_.isPlainObject(t)?[t]:t,t=t.sort(function(t){return function(i,n){var e,s;return(null!=(e=i.ranges[0].price)?e[t.currency]:void 0)-(null!=(s=n.ranges[0].price)?s[t.currency]:void 0)}}(this)),this.shippingRates=t):this.shippingRates=[],this.shippingRates.length)return this.shipping_options=this.shippingRates[0]},t.prototype.getShippingRate=function(){var t,i;return t=this.$q.defer(),i=this.findShippingRate(),t.resolve(i),t.promise},t.prototype.findShippingRate=function(){var t,i;if(this.country)return this.imagoUtils.inUsa(this.country)&&(this.country="United States"),i=_.filter(this.shippingmethods,function(t){return function(i){var e,s,o;return i.active&&(s=null!=(o=t.country)?o.toUpperCase():void 0,n.call(function(){var t,n,s,o;for(s=i.countries,o=[],t=0,n=s.length;t<n;t++)e=s[t],o.push(e.toUpperCase());return o}(),s)>=0)}}(this)),this.state?(t=_.filter(i,function(t){return function(i){var e,s;return e=t.state.toUpperCase(),n.call(function(){var t,n,e,o;for(e=i.states,o=[],t=0,n=e.length;t<n;t++)s=e[t],o.push(s.toUpperCase());return o}(),e)>=0}}(this)),(null!=t?t.length:void 0)?t:(t=_.filter(i,function(t){return function(t){return!t.states.length}}(this)),t.length?t:_.filter(this.shippingmethods,function(t){return!t.countries.length}))):i.length?i:_.filter(this.shippingmethods,function(t){return!t.countries.length})},t.prototype.changeShipping=function(){return this.calcShipping(this.shipping_options).then(function(t){return function(i){return t.costs.shipping=i.shipping,t.calculate()}}(this))},t.prototype.calculateShipping=function(){return this.$q(function(t){return function(i,n){return t.calculateShippingRunning?n():(t.calculateShippingRunning=!0,t.costs.shipping=0,t.getShippingRate().then(function(n){var e,s,o,r;if(t.calculateShippingRunning=!1,!(null!=n?n.length:void 0))return t.shipping_options=void 0,t.shippingRates=[],t.country&&(t.error.noshippingrule=!0),i();for(t.error.noshippingrule=!1,r=[],e=0,s=n.length;e<s;e++)o=n[e],r.push(t.calcShipping(o).then(function(e){var s,o,r;if(t.shipping_options&&t.shipping_options._id===e.rate._id?(t.costs.shipping=e.shipping,i()):t.shipping_options&&!_.difference(t.shippingRates,n).length||(t.setShippingRates(n),t.costs.shipping=e.shipping,i()),null!=(o=t.shippingRates)?o.length:void 0)return s=(e.shipping/100).toFixed(2),r=_.find(t.shippingRates,{_id:e.rate._id}),r.nameprice=r.name+" ("+t.currency+" "+s+")"}));return r}))}}(this))},t.prototype.calcShipping=function(t){return this.$q(function(i){return function(n,e){var s,o,r,a,c,u,h,p,l,d,g,f,y,m,v,S,C;for(s=0,C=[],S=0,p=i.cart.items,o=0,c=p.length;o<c;o++)r=p[o],(null!=(l=r.fields.overwriteShippingCosts)&&null!=(d=l.value)?d[i.currency]:void 0)?C.push(r):(null!=(g=r.fields.calculateShippingCosts)?g.value:void 0)&&(s+="weight"===t.type?((null!=(f=r.fields.weight)?f.value:void 0)||1)*r.qty:r.qty);if(0===s&&"weight"!==t.type&&!C.length)return n({shipping:0,rate:t});for(h=_.find(t.ranges,function(t){return s<=t.to_unit&&s>=t.from_unit}),h||(h=_.last(t.ranges)),s&&(S=null!=(y=h.price)?y[i.currency]:void 0),a=0,u=C.length;a<u;a++)r=C[a],S+=((null!=(m=r.fields.overwriteShippingCosts)&&null!=(v=m.value)?v[i.currency]:void 0)||0)*r.qty;return n({shipping:S,rate:t})}}(this))},t.prototype.calculateTax=function(){return this.getTaxRate().then(function(t){return function(){var i,n,e,s,o,r,a,c,u,h,p,l;t.costs.tax=0;{if(!t.imagoUtils.includesTax(t.currency)){for(l=0,u=t.cart.items,e=0,o=u.length;e<o;e++)n=u[e],(null!=(h=n.fields.calculateTaxes)?h.value:void 0)&&n.price[t.currency]&&(l+=Math.round(n.price[t.currency]*n.qty));return"percent"===(null!=(p=t.coupon)?p.meta.type:void 0)&&t.coupon.meta.value&&(l-=l*t.coupon.meta.value/100),t.costs.tax=Math.round(l*t.costs.taxRate),t.costs.tax}if(t.costs.includedTax=0,t.costs.taxRate){for(a=t.cart.items,i=0,s=a.length;i<s;i++)n=a[i],(null!=(c=n.fields.calculateTaxes)?c.value:void 0)&&(r=n.price[t.currency]/(100+100*t.costs.taxRate)*n.qty,t.costs.includedTax+=r*t.costs.taxRate*100);return}}}}(this))},t.prototype.getTaxRate=function(){return this.$q(function(t){return function(i){var n;return t.costs.taxRate=0,t.country?(n=t.findTaxRate(),n.autotax&&t.imagoUtils.inUsa(t.country)?void t.getZipTax().then(function(){return i()}):(t.costs.taxRate=n.rate/100,i())):i()}}(this))},t.prototype.findTaxRate=function(){var t,i,e,s,o;return this.country?("United States of America"!==(s=this.country)&&"USA"!==s||(this.country="United States"),e=_.filter(this.taxes,function(t){return function(i){var e,s,o;return i.active&&(s=null!=(o=t.country)?o.toUpperCase():void 0,n.call(function(){var t,n,s,o;for(s=i.countries,o=[],t=0,n=s.length;t<n;t++)e=s[t],o.push(e.toUpperCase());return o}(),s)>=0)}}(this)),e.length||(e=_.filter(this.taxes,function(t){return function(t){return t.active&&!t.countries.length}}(this))),this.state?(t=_.find(e,function(t){return function(i){var e,s;return e=t.state.toUpperCase(),n.call(function(){var t,n,e,o;for(e=i.states,o=[],t=0,n=e.length;t<n;t++)s=e[t],o.push(s.toUpperCase());return o}(),e)>=0}}(this)))?t:(i=_.filter(e,function(t){return 0===t.states.length}),(null!=i?i[0]:void 0)||{rate:0}):(null!=e?e[0]:void 0)&&!(null!=(o=e[0].states)?o.length:void 0)?null!=e?e[0]:void 0:{rate:0}):{rate:0}},t.prototype.getZipTax=function(){return this.$q(function(t){return function(i){var n;return t.zip||(null!=(n=t.zip)?n.length:void 0)>4?t.$http.get(t.imagoModel.host+"/api/ziptax?zipcode="+t.zip).then(function(n){return t.costs.taxRate=n.data.taxUse,i()}):i()}}(this))},t.prototype.calculateTotal=function(){return this.costs.total=0,this.costs.subtotal&&(this.costs.total+=this.costs.subtotal),this.costs.discount&&(this.costs.total-=this.costs.discount),this.costs.shipping&&(this.costs.total+=this.costs.shipping),this.costs.tax&&(this.costs.total+=this.costs.tax),this.costs.total},t.prototype.checkStock=function(t){var i,e,s,o,r,a,c,u,h,p,l,d,g;if(this.cartError={},this.fcenter=_.find(this.fulfillmentcenters,function(t){return function(i){var e;return e=t.country,n.call(i.countries,e)>=0}}(this)),this.fcenter||(this.fcenter=_.find(this.fulfillmentcenters,function(t){return!t.countries.length})),!this.fcenter)return t();if(i=!1,null!=(r=this.cart.items)?r.length:void 0){for(a=this.cart.items,e=0,o=a.length;e<o;e++)s=a[e],g=_.isUndefined(null!=(c=s.fields.stock)&&null!=(u=c.value)?u[this.fcenter._id]:void 0)?1e5:null!=(h=s.fields.stock)&&null!=(p=h.value)?p[this.fcenter._id]:void 0,parseInt(g)<s.qty&&!(null!=(l=s.fields)&&null!=(d=l.presale)?d.value:void 0)&&(s.qty=_.max([g,0]),i=!0,0!==g&&(this.cartError[s._id]={maxStock:!0}),g<=0&&(this.cartError[s._id]={noStock:!0}));i&&this.$http.put(this.imagoModel.host+"/api/carts/"+this.cart._id,this.cart)}return t()},t.prototype.calculate=function(){return this.checkStock(function(t){return function(){var i,n,e,s,o;if(t.costs={subtotal:0,shipping:0,tax:0,includedTax:0,total:0},null!=(s=t.cart.items)?s.length:void 0){for(o=t.cart.items,i=0,e=o.length;i<e;i++)n=o[i],n.price[t.currency]&&n.qty&&(t.costs.subtotal+=n.qty*n.price[t.currency]);t.costs.total=t.costs.subtotal}return t.$q.all([t.calculateTax(),t.calculateShipping()]).then(function(){return t.coupon&&t.applyCoupon(t.coupon,t.costs),t.calculateTotal(),t.finalCosts=angular.copy(t.costs)})}}(this))},t.prototype.formatForm=function(t){var i,n;return t.costs=angular.copy(this.costs),t.costs.shipping_options=angular.copy(this.shipping_options),t.costs.coupon=angular.copy(this.coupon)||null,t.shipping_address||(t.shipping_address={}),t.billing_address.phone=angular.copy(this.form.phone),t.shipping_address.phone=angular.copy(this.form.phone),t.fulfillmentcenter=angular.copy(null!=(i=this.fcenter)?i._id:void 0),t.userData={browser:null!=(n=window.navigator)?n.userAgent:void 0},this.differentshipping||(t.shipping_address=angular.copy(this.form.billing_address)),t},t.prototype.submit=function(){var t;return this.form.items=angular.copy(this.cart.items),this.form.currency=angular.copy(this.currency),this.form.cartId=angular.copy(this.cart._id),this.form.billing_address.name=angular.copy(null!=(t=this.form.user)?t.name:void 0),this.form=this.formatForm(this.form),this.$http.post(this.imagoModel.host+"/api/checkout",this.form)},t.prototype.saveCart=function(t){var i,n;return i=angular.copy(this.cart),i.currency=this.currency,i.data=angular.copy(this.form),i.data.paymentType=angular.copy(this.paymentType),i.data.differentshipping=this.differentshipping,i.data=this.formatForm(i.data),t?(i=angular.toJson(i),n=new XMLHttpRequest,n.open("PUT",this.imagoModel.host+"/api/carts/"+this.cart._id,!1),n.setRequestHeader("Content-type","application/json"),n.send(i)):this.$http.put(this.imagoModel.host+"/api/carts/"+this.cart._id,i)},t}(),angular.module("imago").service("calculation",["$q","$state","$http","$auth","imagoUtils","imagoModel",t])}.call(this),function(){var t,i;t=function(){function t(){return{scope:{costs:"=",currency:"=",hideIfNotCountry:"=?"},templateUrl:"/imago/costs.html",controller:"costsController as costs"}}return t}(),i=function(){function t(t,i,n){n.hideIfNotCountry?t.hideIfNotCountry||t.$watch("hideIfNotCountry",function(i){return t.hideCountryDefined=angular.isDefined(i)}):(t.hideIfNotCountry=!1,t.hideCountryDefined=!0)}return t}(),angular.module("imago").directive("costs",[t]).controller("costsController",["$scope","$element","$attrs",i])}.call(this),angular.module("imago").run(["$templateCache",function(t){t.put("/imago/costs.html",'<table><tbody><tr><th>Subtotal</th><td><span ng-bind-html="currency | currencySymbol" class="currency"></span>{{ costs.subtotal | price }}</td></tr><tr ng-show="costs.discount"><th>Discount</th><td><span ng-bind-html="currency | currencySymbol" class="currency"></span>- {{ costs.discount | price }}</td></tr><tr ng-show="!hideIfNotCountry &amp;&amp; hideCountryDefined"><th>Shipping</th><td ng-show="costs.shipping"><span ng-bind-html="currency | currencySymbol" class="currency"></span>{{ costs.shipping | price }}</td><td ng-hide="costs.shipping">free</td></tr><tr ng-show="costs.includedTax &amp;&amp; !hideIfNotCountry &amp;&amp; hideCountryDefined"><th>Included Tax</th><td><span ng-bind-html="currency | currencySymbol" class="currency"></span>{{ costs.includedTax | price }}</td></tr><tr ng-show="!costs.includedTax &amp;&amp; !hideIfNotCountry &amp;&amp; hideCountryDefined"><th>Tax</th><td><span ng-bind-html="currency | currencySymbol" class="currency"></span>{{ costs.tax | price }}</td></tr><tr class="total"><th>Total</th><td><span ng-bind-html="currency | currencySymbol" class="currency"></span>{{ costs.total | price }}</td></tr></tbody></table>')}]);