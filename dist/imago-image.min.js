!function(){function h(t,i){return function(){return t.apply(i,arguments)}}var t,i;function e(t,i,e,s,r,o){this.$rootScope=t,this.$timeout=i,this.$attrs=e,this.$scope=s,this.$element=r,this.imagoModel=o,this.render=h(this.render,this),this.setServingSize=h(this.setServingSize,this),this.loaded=!1,this.imageStyle={},this.watchers=[],this.opts={align:"center center",sizemode:"fit",autosize:"none",responsive:!0,scale:1,lazy:!0,maxsize:4e3,placeholder:this.$rootScope.imagePlaceholder||!1,allowDrag:!0,width:void 0,height:void 0,path:"",limitScales:!0,webp:this.$rootScope.webp}}t=function(){return{templateUrl:"/imago/imago-image.html",controller:"imagoImageController",require:{sliderCtrl:"?^imagoSlider"},bindings:{data:"<?"}}},e.prototype.$postLink=function(){var t,i,e,s,r,o;for(t in this.$attrs)_.isUndefined(this.opts[t])||("true"===(i=this.$attrs[t])||"false"===i?this.opts[t]=JSON.parse(this.$attrs[t]):isNaN(this.$attrs[t])?this.opts[t]=this.$attrs[t]:this.opts[t]=Number(this.$attrs[t]));return this.$attrs.data.match(/[0-9a-fA-F]{24}/)?e=this.$attrs.$observe("data",(o=this,function(t){if(t)return e(),imagoModel.getById(t).then(function(t){return null!=t&&t.serving_url?o.init(t):o.destroy()})})):this.$attrs.data.match(/^\//)?imagoModel.getData(this.$attrs.data).then((r=this,function(t){for(var i,e=0,s=t.length;e<s;e++){if(null==(i=t[e])||!i.serving_url)return r.destroy();r.init(i);break}})):e=this.$scope.$watch("this.imagoimage.data",(s=this,function(){var t;return s.$attrs.watch||(e(),null!=(t=s.data)&&t.serving_url)?s.init(s.data):s.destroy()}))},e.prototype.$onDestroy=function(){for(var t,i=this.watchers,e=[],s=0,r=i.length;s<r;s++)t=i[s],e.push(t());return e},e.prototype.destroy=function(){return this.$scope.$applyAsync((t=this,function(){return t.$scope.$destroy(),t.$element.remove()}));var t},e.prototype.init=function(t){var i,e,s,r;if(null!=t&&t.serving_url)return this.asset=t,this.placeholderUrl=this.asset.b64||this.asset.serving_url+"=s3",this.resolution=this.asset.resolution.split("x"),this.assetRatio=_.head(this.resolution)/_.last(this.resolution),this.spacerStyle={paddingBottom:_.last(this.resolution)/_.head(this.resolution)*100+"%"},null!=(t=this.asset.fields)&&null!=(t=t.crop)&&t.value&&!this.$attrs.align&&(this.opts.align=this.asset.fields.crop.value),null!=(t=this.asset.fields)&&null!=(t=t.sizemode)&&t.value&&"default"!==this.asset.fields.sizemode.value&&!this.$attrs.sizemode&&(this.opts.sizemode=this.asset.fields.sizemode.value),this.opts.responsive&&(this.watchers.push(this.$rootScope.$on("resize",(s=this,function(){if(s.visible)return s.$scope.$applyAsync(function(){return s.getSize(),s.resize()})}))),this.watchers.push(this.$rootScope.$on("resizestop",(e=this,function(){if(e.visible)return e.$scope.$applyAsync(function(){return e.getSize(),e.resize(),e.getServingUrl()})}))),this.watchers.push(this.$rootScope.$on("widgetreset",(i=this,function(){return i.getSize(),i.resize(),i.getServingUrl()})))),this.$scope.$applyAsync((r=this,function(){var i;return r.$attrs.width||r.$attrs.height?(r.width=parseInt(r.$attrs.width||0),r.height=parseInt(r.$attrs.height||0)):r.getSize(),0===r.height&&0===r.width?console.warn("need width or/and height for static or relative positioning"):(0<r.height&&0===r.width?r.mainSide="autoheight":0<r.width&&0===r.height?r.mainSide="autowidth":"crop"===r.opts.sizemode?r.mainSide=1<r.assetRatio?"height":"width":r.mainSide=r.assetRatio<1?"height":"width",r.opts.lazy&&!r.visible?i=r.$scope.$watch("imagoimage.visible",function(t){if(t)return i(),r.resize(),r.getServingUrl()}):(r.getSize(),r.resize(),r.getServingUrl()))}))},e.prototype.getSize=function(){if(this.width=this.$element.children()[0].clientWidth,this.height=this.$element.children()[0].clientHeight,window.debug)return console.debug("imago-image: getSize "+this.width+"x"+this.height)},e.prototype.setServingSize=function(t){if(this.sliderCtrl)return this.sliderCtrl.setServingSize(t)},e.prototype.inview=function(t){var i;if(null!=(i=this.asset)&&i.serving_url)return this.visible=t,this.getSize(),this.resize(),this.getServingUrl()},e.prototype.resize=function(){var t;if("autoheight"!==(t=this.mainSide)&&"autowidth"!==t&&(this.wrapperRatio=this.width/this.height,"crop"===this.opts.sizemode?this.mainSide=this.assetRatio<this.wrapperRatio?"width":"height":this.mainSide=this.assetRatio>this.wrapperRatio?"width":"height"),window.debug)return console.debug("imago-image: resize "+this.width+"x"+this.height+" @mainSide "+this.mainSide)},e.prototype.getServingUrl=function(){var t="autoheight"===this.mainSide?Math.round(Math.max(this.height,this.height*this.assetRatio)):"crop"===this.opts.sizemode&&this.height?this.assetRatio<=this.wrapperRatio?Math.round(Math.max(this.width,this.width/this.assetRatio)):Math.round(Math.max(this.height,this.height*this.assetRatio)):this.assetRatio<=this.wrapperRatio&&this.height?Math.round(Math.max(this.height,this.height*this.assetRatio)):Math.round(Math.max(this.width,this.width/this.assetRatio));if(t=parseInt(Math.min(t*(Math.ceil(window.devicePixelRatio,1)||1),this.opts.maxsize)),(t=this.opts.limitScales?250*Math.ceil(t/250):t)!==this.servingSize)return this.servingSize=Math.max(t,60),this.opts.servingUrl=this.asset.serving_url+"=s"+this.servingSize*this.opts.scale,this.opts.webp&&(this.opts.servingUrl=this.opts.servingUrl+"-rw"),this.setServingSize("=s"+t*this.opts.scale),window.debug&&console.debug("imago-image: getServingUrl servingSize: "+t*this.opts.scale),this.render();this.loaded=!0},e.prototype.render=function(){var t,i;return window.debug&&(console.time(this.asset.uuid),console.debug("imago-image: render",this.asset.uuid)),(t=angular.element("<img>")).on("load",(i=this,function(){return i.$scope.$applyAsync(function(){return window.debug&&(console.debug("imago-image: render loaded",i.asset.uuid),console.timeEnd(i.asset.uuid)),i.imgUrl=i.opts.servingUrl,i.loaded=!0})})),t[0].src=this.opts.servingUrl},i=e,angular.module("imago").component("imagoImage",new t).controller("imagoImageController",["$rootScope","$timeout","$attrs","$scope","$element","imagoModel",i])}.call(this),angular.module("imago").run(["$templateCache",function(t){t.put("/imago/imago-image.html",'<div ng-class="[{\'loaded\': $ctrl.loaded}, $ctrl.opts.align, $ctrl.opts.sizemode, $ctrl.mainSide, {\'noplaceholder\': !$ctrl.opts.placeholder}]" in-view="$ctrl.inview($inview)" in-view-options="{throttle: 300, offset:[-100, 0, 100, 0]}" class="imago-image-content"><div ng-style="::$ctrl.spacerStyle" class="spacer"></div><img ng-src="{{::$ctrl.placeholderUrl}}" class="small"/><img ng-src="{{$ctrl.imgUrl}}" class="large"/><div ng-if="!$ctrl.opts.allowDrag" class="prevent-drag"></div></div>')}]);