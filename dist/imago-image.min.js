(function(){var t,i,e=function(t,i){return function(){return t.apply(i,arguments)}};t=function(){function t(){return{templateUrl:"/imago/imago-image.html",controller:"imagoImageController as imagoimage",require:{sliderCtrl:"?^imagoSlider"},bindings:{data:"=?"}}}return t}(),i=function(){function t(t,i,s,o,a){this.$rootScope=t,this.$attrs=i,this.$scope=s,this.$element=o,this.imagoModel=a,this.render=e(this.render,this),this.setServingSize=e(this.setServingSize,this),this.loaded=!1,this.imageStyle={},this.watchers=[],this.opts={align:"center center",sizemode:"fit",autosize:"none",responsive:!0,scale:1,lazy:!0,maxsize:4e3,placeholder:!1,allowDrag:!0,width:void 0,height:void 0,path:""}}return t.prototype.$postLink=function(){var t,i,e;for(t in this.$attrs)_.isUndefined(this.opts[t])||("true"===(i=this.$attrs[t])||"false"===i?this.opts[t]=JSON.parse(this.$attrs[t]):isNaN(this.$attrs[t])?this.opts[t]=this.$attrs[t]:this.opts[t]=Number(this.$attrs[t]));return this.$attrs.data.match(/[0-9a-fA-F]{24}/)?e=this.$attrs.$observe("data",function(t){return function(i){return i?(e(),imagoModel.getById(i).then(function(i){return(null!=i?i.serving_url:void 0)?t.init(i):t.destroy()})):void 0}}(this)):this.$attrs.data.match(/^\//)?imagoModel.getData(this.$attrs.data).then(function(t){return function(i){var e,s,o;for(e=0,o=i.length;o>e;e++){if(s=i[e],!(null!=s?s.serving_url:void 0))return t.destroy();t.init(s);break}}}(this)):e=this.$scope.$watch("this.imagoimage.data",function(t){return function(){var i;return t.$attrs.watch||e(),(null!=(i=t.data)?i.serving_url:void 0)?t.init(t.data):t.destroy()}}(this))},t.prototype.$onDestroy=function(){var t,i,e,s,o;for(e=this.watchers,s=[],t=0,i=e.length;i>t;t++)o=e[t],s.push(o());return s},t.prototype.destroy=function(){return this.$scope.$applyAsync(function(t){return function(){return t.$scope.$destroy(),t.$element.remove()}}(this))},t.prototype.init=function(t){var i,e,s,o;return this.asset=t,this.placeholderUrl=this.asset.b64||this.asset.serving_url+"=s3",this.resolution=this.asset.resolution.split("x"),this.assetRatio=_.head(this.resolution)/_.last(this.resolution),this.spacerStyle={paddingBottom:_.last(this.resolution)/_.head(this.resolution)*100+"%"},(null!=(i=this.asset.fields)&&null!=(e=i.crop)?e.value:void 0)&&!this.$attrs.align&&(this.opts.align=this.asset.fields.crop.value),(null!=(s=this.asset.fields)&&null!=(o=s.sizemode)?o.value:void 0)&&"default"!==this.asset.fields.sizemode.value&&!this.$attrs.sizemode&&(this.opts.sizemode=this.asset.fields.sizemode.value),this.opts.responsive&&(this.watchers.push(this.$rootScope.$on("resize",function(t){return function(){return t.visible?t.$scope.$applyAsync(function(){return t.getSize(),t.resize()}):void 0}}(this))),this.watchers.push(this.$rootScope.$on("resizestop",function(t){return function(){return t.visible?t.$scope.$applyAsync(function(){return t.getSize(),t.resize(),t.getServingUrl()}):void 0}}(this)))),this.$scope.$applyAsync(function(t){return function(){var i;return t.$attrs.width||t.$attrs.height?(t.width=parseInt(t.$attrs.width||0),t.height=parseInt(t.$attrs.height||0)):t.getSize(),0===t.height&&0===t.width?console.log("need width or/and height for static or relative positioning"):(t.height>0&&0===t.width?t.mainSide="autoheight":t.width>0&&0===t.height?t.mainSide="autowidth":"crop"===t.opts.sizemode?t.mainSide=t.assetRatio>1?"height":"width":t.mainSide=t.assetRatio<1?"height":"width",t.opts.lazy&&!t.visible?i=t.$scope.$watch("imagoimage.visible",function(e){return e?(i(),t.resize(),t.getServingUrl()):void 0}):(t.getSize(),t.resize(),t.getServingUrl()))}}(this))},t.prototype.getSize=function(){return this.width=this.$element.children()[0].clientWidth,this.height=this.$element.children()[0].clientHeight},t.prototype.setServingSize=function(t){return this.sliderCtrl?this.sliderCtrl.setServingSize(t):void 0},t.prototype.resize=function(){var t;return"autoheight"!==(t=this.mainSide)&&"autowidth"!==t?(this.wrapperRatio=this.width/this.height,"crop"===this.opts.sizemode?this.mainSide=this.assetRatio<this.wrapperRatio?"width":"height":this.mainSide=this.assetRatio>this.wrapperRatio?"width":"height"):void 0},t.prototype.getServingUrl=function(){var t;return this.visible=!0,t="autoheight"===this.mainSide?Math.round(Math.max(this.height,this.height*this.assetRatio)):"crop"===this.opts.sizemode&&this.height?this.assetRatio<=this.wrapperRatio?Math.round(Math.max(this.width,this.width/this.assetRatio)):Math.round(Math.max(this.height,this.height*this.assetRatio)):this.assetRatio<=this.wrapperRatio&&this.height?Math.round(Math.max(this.height,this.height*this.assetRatio)):Math.round(Math.max(this.width,this.width/this.assetRatio)),t=parseInt(Math.min(t*(Math.ceil(window.devicePixelRatio,1)||1),this.opts.maxsize)),t===this.servingSize?void(this.loaded=!0):(this.servingSize=Math.max(t,60),this.opts.servingUrl=this.asset.serving_url+"=s"+this.servingSize*this.opts.scale,this.setServingSize("=s"+t*this.opts.scale),this.render())},t.prototype.render=function(){var t;return t=angular.element("<img>"),t.on("load",function(t){return function(){return t.$scope.$applyAsync(function(){return t.imgUrl=t.opts.servingUrl,t.loaded=!0})}}(this)),t[0].src=this.opts.servingUrl},t}(),angular.module("imago").component("imagoImage",new t).controller("imagoImageController",["$rootScope","$attrs","$scope","$element","imagoModel",i])}).call(this),angular.module("imago").run(["$templateCache",function(t){t.put("/imago/imago-image.html",'<div ng-class="[{\'loaded\': imagoimage.loaded}, imagoimage.opts.align, imagoimage.opts.sizemode, imagoimage.mainSide, {\'noplaceholder\': !imagoimage.opts.placeholder}]" in-view="imagoimage.visible = $inview" in-view-options="{debounce: 10, offsetTop: -100, offsetBottom: 100}" class="imago-image-content"><div ng-style="::imagoimage.spacerStyle" class="spacer"></div><img ng-src="{{::imagoimage.placeholderUrl}}" class="small"/><img ng-src="{{imagoimage.imgUrl}}" class="large"/><div ng-if="!imagoimage.opts.allowDrag" class="prevent-drag"></div></div>')}]);